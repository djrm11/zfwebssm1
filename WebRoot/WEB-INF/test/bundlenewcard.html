










<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>国泰君安综合理财服务系统 -</title>
<meta content="IE=7" http-equiv="X-UA-Compatible" />
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
<link rel="stylesheet"
	href="http://10.176.108.50:8080/biz-iwm/css/horn/h_ui.css"
	type="text/css">
	<link rel="stylesheet"
		href="http://10.176.108.50:8080/biz-iwm/components/components.css"
		type="text/css">
		<link rel="stylesheet"
			href="http://10.176.108.50:8080/biz-iwm/plugins/lhgcalendar/skins/lhgcalendar.css"
			type="text/css">
			<link rel="stylesheet"
				href="http://10.176.108.50:8080/biz-iwm/plugins/ztree/zTreeStyle/zTreeStyle.css"
				type="text/css">
				<link rel="stylesheet"
					href="http://10.176.108.50:8080/biz-iwm/css/user/gtja_components.css"
					type="text/css">
					<link rel="stylesheet"
						href="http://10.176.108.50:8080/biz-iwm/css/horn/h_iframe.css"
						type="text/css">
						<link rel="stylesheet"
							href="http://10.176.108.50:8080/biz-iwm/css/horn/h_index.css"
							type="text/css">
							<link rel="stylesheet"
								href="http://10.176.108.50:8080/biz-iwm/css/user/user.css"
								type="text/css">
								<link rel="stylesheet"
									href="http://10.176.108.50:8080/biz-iwm/dhtmlx/dhtmlx.css"
									type="text/css">
									<script
										src="http://10.176.108.50:8080/biz-iwm/scripts/bigpipe.mini.js"
										type="text/javascript"></script>
									<script
										src="http://10.176.108.50:8080/biz-iwm/scripts/jquery.mini.js"
										type="text/javascript"></script>
									<script
										src="http://10.176.108.50:8080/biz-iwm/scripts/horn/horn.core.js"
										type="text/javascript"></script>
									<script
										src="http://10.176.108.50:8080/biz-iwm/components/components.js"
										type="text/javascript"></script>
									<script
										src="http://10.176.108.50:8080/biz-iwm/plugins/lhgcalendar/lhgcalendar.js"
										type="text/javascript"></script>
									<script
										src="http://10.176.108.50:8080/biz-iwm/plugins/lhgcalendar/lhgcalendar.min.js"
										type="text/javascript"></script>
									<script
										src="http://10.176.108.50:8080/biz-iwm/plugins/lhgcalendar/lhgcore.lhgcalendar.min.js"
										type="text/javascript"></script>
									<script
										src="http://10.176.108.50:8080/biz-iwm/plugins/ztree/jquery.ztree.core-3.5.min.js"
										type="text/javascript"></script>
									<script
										src="http://10.176.108.50:8080/biz-iwm/plugins/ztree/jquery.ztree.excheck-3.5.min.js"
										type="text/javascript"></script>
									<script
										src="http://10.176.108.50:8080/biz-iwm/plugins/ztree/jquery.ztree.exhide-3.5.min.js"
										type="text/javascript"></script>
									<script
										src="http://10.176.108.50:8080/biz-iwm/scripts/iwm.idcard.js"
										type="text/javascript"></script>
									<script
										src="http://10.176.108.50:8080/biz-iwm/scripts/fileUploadOcx.js"
										type="text/javascript"></script>
									<script
										src="http://10.176.108.50:8080/biz-iwm/scripts/horn/hc_gtja.js"
										type="text/javascript"></script>
									<script
										src="http://10.176.108.50:8080/biz-iwm/dhtmlx/dhtmlx.js"
										type="text/javascript"></script>
									<script
										src="http://10.176.108.50:8080/biz-iwm/dhtmlx/hc_dhtmlx.js"
										type="text/javascript"></script>
									<script src="http://10.176.108.50:8080/biz-iwm/scripts/iwm.js"
										type="text/javascript"></script>
									<script
										src="http://10.176.108.50:8080/biz-iwm/scripts/iwm.querytable.js"
										type="text/javascript"></script>
									<script
										src="http://10.176.108.50:8080/biz-iwm/scripts/iwm.select.js"
										type="text/javascript"></script>
									<script
										src="http://10.176.108.50:8080/biz-iwm/scripts/iwm.pwd.js"
										type="text/javascript"></script>

									<script type="text/javascript">
		var context_path = "http://10.176.108.50:8080/biz-iwm/" ;
		if(context_path.lastIndexOf("/")==context_path.length-1){
			context_path = context_path.substr(0,context_path.length-1) ;
		}
	</script>
</head>
<body>
	<script src="http://10.176.108.50:8080/biz-iwm/scripts/iwm.imm.js"
		type="text/javascript"></script>
	<script type="text/javascript">
var menu_id = "390201" ;
</script>

	<div class="h_screen">



		<div class="h_screen-content-3">
			<h1>
				<span>更换银行卡</span>
			</h1>
			<style type="text/css">
.check-alt {
	padding: 10px;
	margin: 5px;
	user-select: none
}

.check-alt>div {
	float: left;
}

.check-alt .default {
	background: url("../../css/check_alt_default.png") no-repeat;
	padding-left: 15px;
}

.default>.text {
	color: #AAACAF;
}

.check-alt .success {
	background: url("../../css/check_alt_success.png") no-repeat;
	padding-left: 15px;
}

.check-alt .error {
	background: url("../../css/check_alt_error.png") no-repeat;
	padding-left: 15px;
}

.error>.text {
	color: #F00;
}

.msg-btn {
	color: blue;
	width: 50px;
	height: 22px;
	border: 0px;
	font-size: 12px;
}

.h_floatdiv-title a {
	font-size: 14px
}

.h_floatdiv-con button {
	margin-left: 100px;
}

.h_btndiv .btn-left {
	margin-left: 80px;
}

.h_btndiv .btn-right {
	margin-left: 30px;
}

img {
	vertical-align: middle
}
</style>
			<div class="h_columns-3">
				<form method="post" action="" ajax="" beforeSubmit="" onSuccess=""
					name="bundlenewcardForm" autocomplete="off">
					<input type="hidden" name="sourceurl"
						value="/iwm/newam/bundlenewcard" /> <input type="hidden"
						name="tab" value="true" />
					<div class="h_colspan-2" style="height:270px;" name="_colspan">
						<div class=" userborderR userborderB" style="height:269px;"
							name="_border">
							<ul class="h_panel" name="">









								<li class="hc_panel-li "><span title="身份证号码"
									style="visibility:hidden;"> <b class="hc_red">*</b>
										身份证号码</span>
									<div class="hc_switchfield">
										<input type="text" name="account_content" value=""
											check="required;" url="/switchFieldCheck/getCifInfo.json"
											param="" success="switchField_success()"
											error="switchField_error()" />
										<div class="hc_checkboxdiv">
											<ul>
											</ul>
										</div>
									</div>
									<div style="display:none;"></div>
									<div class="hc_switchfieldlabel ">
										<span title="身份证号码"> <b class="hc_red"> * </b> 身份证号码<input
											type="hidden" name="input_content" value="70" />
										</span>
										<ul>
											<li title="一户通号" key="0"><label> 一户通号
											</label>
											</li>
											<li title="身份证号码" key="70" class="h_cur"><label>
													身份证号码 </label>
											</li>
											<li title="其他证件号" key="7"><label>
													其他证件号 </label>
											</li>
											<li title="客户代码" key="6"><label> 客户代码
											</label>
											</li>
											<li title="一码通号" key="m"><label> 一码通号
											</label>
											</li>
										</ul>
									</div></li>

								<input type="hidden" name="card_id_enddate" value="" />
								<input type="hidden" name="action_Type_No" value="" />
								<input type="hidden" name="action_Type_No1" value="" />
								<input type="hidden" name="hsMune_Type0" value="" />
								<input type="hidden" name="gt_menu_type0" value="" />
								<input type="hidden" name="gt_menu_type1" value="" />
								<input type="hidden" name="hsMune_Type1" value="" />
								<input type="hidden" name="organ_flag_stauts_type" value="" />
								<input type="hidden" name="organ_flag_status1" value="" />
								<input type="hidden" name="organ_flag_status0" value="" />
								<input type="hidden" name="cif_account_NO" value="" />
								<input type="hidden" name="jxtx_fllow_flag_type" value="" />
								<input type="hidden" name="jxtx_fllow_flag_type1" value="" />
								<input type="hidden" name="id_auth_type" value="" />
								<input type="hidden" name="check_flag" value="" />
								<input type="hidden" name="showClientControl_flag" value="" />


								<script type="text/javascript">
var sfInfourl = "/switchFieldCheck/getCifInfoCifAccount.json" ;
var sFshowList = Horn.SwitchField.prototype.showList ;
var sFbodyClick = Horn.SwitchField.prototype.bodyClick ;
var sFonBeforeSend = Horn.SwitchField.prototype.onBeforeSend ;
var g_account_content;
Horn.override(Horn.SwitchField , {
	userListEl : null,
	showList : function(){
		return ;
		if(this.listEl.css("display")=="block"){
			return ;
		}
		var li = this.listEl.children("ul").children("li[key]") ;
		if(li.size()==0){
			li.css("height","0px");
		}
	},
	bodyClick : function(e){
		sFbodyClick.apply(this,arguments) ;
		if(e.target!=this.field.get(0)){
			$(document).one("click",Horn.Util.apply(this.userBodyClick,this));
		}
	},
	addUserList : function(list,url,success,failure){
		if(this.userListEl==null){
			var html = '<div class="hc_checkboxdiv" ref_target="'+this.name+'">' ;
			html += '<ul>' ;
			html += '</ul>' ;
			html += '</div>' ;
			this.userListEl = $(html) ;
			$("div.hc_hide_div").append(this.userListEl) ;
		}
		var ul = this.userListEl.children("ul") ;
		ul.children("li").remove() ;
		if (list && list.length > 0) {
			var width = this.field.outerWidth() + 10
			jQuery.each(list, function(index, obj) {
				if (obj.label) {
					var text = obj.label + ":" + obj.value ;
					var liHtml = "<li key='" + obj.label + "' "
						+ "title='"	+ obj.value + "'"
						+ " branch_no='" + obj.branch_no + "'"
						+ "><label>"
						+ text + "</label></li>";
					ul.append(jQuery(liHtml));
					if(text.getRealLength() * 5.6>width){
						width = text.getRealLength() * 6 ;
					}
				}
			});
			var data = {'url':url,'success':success,'failure':failure} ;
			var li = ul.children("li") ;
    		// 列表事件绑定
    		li.bind('click.li', data, Horn.Util.apply(this.userListClick,this));
			this.showUserList(width) ;
		}
	},
	showUserList : function(width) {
		if(this.userListEl.css("display")=="block"){
			return ;
		}
		var ul = this.userListEl.children("ul") ;
		var li = ul.children("li[key]") ;
		var offset = this.field.offset(), listOuterHeight = this.field.outerHeight();
		// 显示位置
		this.userListEl.css("left",offset.left + "px") ;
		this.userListEl.css("top",(offset.top + listOuterHeight) + "px") ;
		this.userListEl.css("width",width + "px") ;
		// 显示
		this.userListEl.css("display","block");
		li.first().addClass("h_cur");
	} ,
	hideUserList : function(){
		this.userListEl.css("display","none") ;
	},
	userListClick : function(e){
		var li = $(e.currentTarget);
		this.userItemClick(e,li) ;
	},
	userItemClick : function(e,li){
		if(li && li.size()>0){
    		var field = this.field ;
    		var oldVal = field.val();
			var branch_no = li.attr("branch_no") ;
			var cif_account = li.attr("key") ;
    		// field.val(jQuery.trim(cif_account));
    		li.siblings().removeClass("h_cur");
    		li.addClass("h_cur");
    		this.hideUserList() ;
			this.ajaxCifAccount(e,cif_account,branch_no) ;
		}
	},
	userBodyClick : function(e){
		if(this.userListEl){
    		if(e.target==this.field.get(0)){
    			$(document).one("click",Horn.Util.apply(this.userBodyClick,this));
    		}
    		else if(this.userListEl.css("display")=="block"){
        		var ul = this.userListEl.children("ul") ;
        		var li = ul.children("li.h_cur") ;
				li.triggerHandler("click.li") ;
        		// this.userItemClick(e,li) ;
    		}
		}
	},
	ajaxCifAccount : function(e,cif_account,branch_no){
    	var check_right = "1" ;
    	var gt_menu_type0 = "1" ;
    	var gt_menu_type1 = "" ;
    	var organ_flag_status0="0";
    	var organ_flag_status1="";
    	
    	var showClientControl = "1" ;
    	showClientControl = showClientControl || "1" ;
    	
    	    	var failure = "secu.comFailure()" ;
    	failure = Horn.Util.getFunObj(failure).fn ;
    	    	check_right = check_right || "1" ;
		var url = e.data.url || sfInfourl ;
		var param = {"check_right":check_right,"branch_no":branch_no,"cif_account":cif_account,"gt_menu_type0":gt_menu_type0,"gt_menu_type1":gt_menu_type1,"organ_flag_status1":organ_flag_status1,"organ_flag_status0":organ_flag_status0,"showClientControl":showClientControl} 
		Horn.post(url,param,e.data.success||switchField_success,e.data.failure||failure) ;
		// Horn.focusEnd(this.field[0]);
	},
	onBeforeSend : function(xhr){
		Horn.loadMask("loading...") ;
		var labelfield = this.labelfield ;
    	var form = labelfield[0].form ;
    	if(form){
    		var jForm = $(form) ;
    		jForm.one("reset",jQuery.proxy(function(){
    			xhr.abort() ;
    		},this)) ;
    	}
    	// 2015.01.20 xiajia 增加客户代码查询特殊处理 start
    	var name = "account_content" ;
    	var input_content = Horn.getComp(name).getLabelValue() ;
    	if(input_content == "6"){
    		var account_content = Horn.getComp(name).getValue();
    		if(account_content.length <= 12){
    			var accountContent = "03" + "000000000000".substring(account_content.length) + account_content;
    			Horn.Field.setValue(name, accountContent);
    			Horn.getComp('account_content').field.focusout();
    			Horn.hideMask() ;
    			return false;
    		}
    	}
    	// *********************************************** end
    	var account_content=Horn.Field.getValue("account_content");
    	var action_Type_No=Horn.Field.getValue("action_Type_No");
    	if(g_account_content==account_content){
    		g_account_content="";
			if(action_Type_No==1){//为什么判断等于零是，两次事件先会走到apply，然后按照队列循序去调用ajax
				Horn.hideMask() ;
				return false;//第二次循环会走这里
			}else if(action_Type_No==0){
				Horn.hideMask() ;//如果加载延迟那就会走这里
				return false;
			}
    	}else if(action_Type_No!="1"){//第一次循环会走这里。
    		g_account_content=account_content;
    	}else {
    		g_account_content="";//如果第一次输入身份证会走这里
    	}
    	return sFonBeforeSend.apply(this,arguments) ;
	}
});
function switchField_success(data){
	Horn.Field.setValue("organ_flag_stauts_type", data.organ_flag);
	var ret = true;    
	var action_Type_No=Horn.Field.getValue("action_Type_No");
  	var cif_account=data.cif_account;
	var cif_branch_no=data.branch_no;
	var check_flag=data.check;
	Horn.Field.setValue("check_flag", check_flag);
	var hsMune_Type=Horn.Field.getValue("hsMune_Type0");
	var hsMune_Type1=Horn.Field.getValue("hsMune_Type1");
	var organ_flag_status0=Horn.Field.getValue("organ_flag_status0");
	var organ_flag_status1=Horn.Field.getValue("organ_flag_status1");
	var organ_flag_stauts_type=Horn.Field.getValue("organ_flag_stauts_type");
	var menu_id_type = Horn.Util.getParamValue("menu_id") ;
	
	if(action_Type_No==0){
		Horn.Field.setValue("action_Type_No1", "0");
	}else{
		Horn.Field.setValue("action_Type_No1", "1");
	}
	//获取判断当前客户的证件类型是否是身份证
	var id_auth_type = "";
	Horn.Field.setValue("id_auth_type", "");
	if(id_auth_type=="1"){
		var check_ind_kind=data.id_kind;
		if(check_ind_kind=="0"){
			var action_Type_No1=Horn.Field.getValue("action_Type_No1");
			if(action_Type_No1=="1"){
				alert("身份证客户必须要刷卡");
				Horn.getComp("account_content").setValue("", true) ;
				Horn.hideMask() ;
				return;
			}
		}
	}
	
	// 2015.11.12	夏佳		增加刷身份证时，身份证中有效期和数据库有效期不一致，则提示操作员确认！但不强制要求修改
	if(cif_account && action_Type_No == "0" && data.organ_flag == "0"){
		var card_id_enddate = Horn.Field.getValue("card_id_enddate");
		if(!data.id_enddate || (data.id_enddate && $.trim(data.id_enddate) != card_id_enddate)){
			alert("身份证证件有效期与系统留存证件有效期不一致，请注意确认！");
		}
	}
	
	/**
	 * hsMune_Type值为1，刷卡时不需要校验，输身份证校验密码， hsMune_Type值为2，刷卡和输入身份证都需要校验密码
	 * hsMune_Type值为3，只支持刷卡  
	 */ 
	Horn.Field.setValue("jxtx_fllow_flag_type", "0");//缓存如果是个人或者机构要校验客户密码的值
	Horn.Field.setValue("jxtx_fllow_flag_type1", "");//缓存如果是个人或者机构要校验客户密码的值
	if(check_flag==1){
		if(cif_account){
			alert("客户需通过君行天下办理此业务");
		if("4220"!=menu_id_type &&"4221"!=menu_id_type){//屏蔽打印凭条和打印开户凭条校验君行君行天下密码功能
		 if(organ_flag_stauts_type==0){
			if(organ_flag_status0==organ_flag_stauts_type){
				if(hsMune_Type==2){
					var ret =Iwm.Pwd.jxtxCheckPwd("390201","0",cif_account,null,null,null,null);
				}else if(hsMune_Type==3){
					if(action_Type_No==1){
						alert("该操作必须要通过刷身份证完成");
						Horn.getComp("account_content").setValue("", true) ;
						Horn.hideMask() ;
						return;
					}
				}else if(hsMune_Type==1){
					if(action_Type_No==1){
						var ret =Iwm.Pwd.jxtxCheckPwd("390201","0",cif_account,null,null,null,null);
					}
				}
			}else{
				if(hsMune_Type1==2){
					var ret =Iwm.Pwd.jxtxCheckPwd("390201","0",cif_account,null,null,null,null);
				}else if(hsMune_Type1==3){
					if(action_Type_No==1){
						alert("该操作必须要通过刷身份证完成");
						Horn.getComp("account_content").setValue("", true) ;
						Horn.hideMask() ;
						return;
					}
				}
				if(hsMune_Type1==1){
					if(action_Type_No==1){
						var ret =Iwm.Pwd.jxtxCheckPwd("390201","0",cif_account,null,null,null,null);
					}
				}
			}
		  }else{
			  var ret =Iwm.Pwd.jxtxCheckPwd("390201","",cif_account,null,null,null,null);
		 }
		  if(ret){
		      }else{
		    Horn.getComp("account_content").setValue("", true) ;
			 Horn.hideMask() ;
			 return false;
		      }
		   }
	   }
}
	if("170305"==menu_id_type||"170303"==menu_id_type||"170302"==menu_id||"591104"==menu_id){
	  if(cif_account){
		  var action_Type_No1=Horn.Field.getValue("action_Type_No1");
		if(organ_flag_stauts_type==0){
			Horn.Field.setValue("jxtx_fllow_flag_type", "0");
			if(hsMune_Type==3){
				if(action_Type_No1==1){
					alert("该操作必须要通过刷身份证完成");
					Horn.getComp("account_content").setValue("", true) ;
					Horn.hideMask() ;
					return;
				}
			}
			if(hsMune_Type==2){
				var ret =Iwm.Pwd.jxtxCheckPwd("390201","0",cif_account,null,null,null,null);
			}
			if(hsMune_Type==1){
				if(action_Type_No==1){
					var ret =Iwm.Pwd.jxtxCheckPwd("390201","0",cif_account,null,null,null,null);
				}
			}
		}else{
			Horn.Field.setValue("jxtx_fllow_flag_type", "");//缓存如果是个人或者机构要校验客户密码的值
			if(action_Type_No==1){
				if(cif_account){
					var ret =Iwm.Pwd.jxtxCheckPwd("390201","",cif_account,null,null,null,null);
				}
			}
		}
			if(ret){
		      }else{
		    Horn.getComp("account_content").setValue("", true) ;
			 Horn.hideMask() ;
			 return false;
		      }
			
	 }
	}
	if(cif_account){
		Horn.Field.setValue("action_Type_No", "1");
	}
	Horn.hideMask() ;
		var success = "secu.comSuccess()" ;
	success = Horn.Util.getFunObj(success).fn ;
			var failure = "secu.comFailure()" ;
	failure = Horn.Util.getFunObj(failure).fn ;
		var that = this ;
	if(data.errorNo && data.errorNo!='0'){
		var error = Horn.getError(data) ;
		if(jQuery.isFunction(failure)){
			failure.call(this,data) ;
		}
		else{
			alert(error) ;
		}
	}
	else{
		if(jQuery.type(data)=="array"){
			jQuery.each(data,function(index,item){
				item['label'] = item['cif_account'] ;
				item['value'] = (jQuery.trim(item['full_name']) || item['client_name']) +"["+ item['branch_no_name']+"]" +"["+ item['cifacct_status_name']+"]" ;
			})
			this.addUserList(data);
		}
		else{
			success.call(this,data) ;
		}
	}
}
function switchField_error(xhr, textStatus, errorThrown){
	Horn.hideMask() ;
	alert(textStatus) ;
};
Horn.ready(function(){
	var name = "account_content" ;
	var check_right = "1" ;
	check_right = check_right || "1" ;
	/**
	 * 判断该菜单是否有客户代码控件
	 */
	var showClientControl = "1" ;
	showClientControl = showClientControl || "1" ;
	var sf = Horn.getComp(name) ;
	var param = sf.param ;
	var menu_id = Horn.Util.getParamValue("menu_id") ;
	param.push({"name":"menu_id","value":menu_id}) ;
	param.push({"name":"check_right","value":check_right}) ;
	param.push({"name":"showClientControl","value":showClientControl}) ;
	Horn.Field.setValue("showClientControl_flag", showClientControl);//复核君行天下业务标志
	Horn.Field.setValue("hsMune_Type0", "1");// 密码校验标志
	Horn.Field.setValue("hsMune_Type1", "");
	Horn.Field.setValue("organ_flag_status0", "0");
	Horn.Field.setValue("organ_flag_status1", "");// 客户状态
	Horn.Field.setValue("gt_menu_type0", "1");// 客户状态
	Horn.Field.setValue("gt_menu_type1", "");// 客户状态
	param.push({"name":"gt_menu_type0","value":"1"}) ;// 业务菜单类型
	param.push({"name":"gt_menu_type1","value":""}) ;
	param.push({"name":"organ_flag_status0","value":"0"}) ;
	param.push({"name":"organ_flag_status1","value":""}) ;
	Horn.Field.setValue("action_Type_No", "1");
	sf.field.bind("keydown",Horn.Util.apply(function(e){
		var field = this.field ;
        var keyCode = e.keyCode;
        if (keyCode === 13) {
			if(this.userListEl && this.userListEl.css("display")=="block"){
        		var ul = this.userListEl.children("ul") ;
        		var li = ul.children("li.h_cur") ;
				// field.blur() ;
				li.triggerHandler("click.li") ;
                // this.userItemClick(e,li) ;
			}
			else if(field.val()){
			}
			Horn.Util.stopPropagation(e);
            return false;
        }
	},sf)) ;
	var form = sf.labelfield[0].form ;
	if(form){
		var jForm = $(form) ;
		jForm.bind("reset",function(){
			sf.setLabelValue(sf.labelfield.prop("defaultValue")) ;
		}) ;
	}
	
	readIDCard();
}) ;
function readIDCard(){
	var reader = null;
	var labelValue = Horn.getComp("account_content").getLabelValue() ;
	if(labelValue=="70"){
		reader = new Iwm.IdCard(
			function(idInfo){
				Horn.Field.setValue("card_id_enddate", idInfo.id_enddate);
				Horn.Field.setValue("action_Type_No", "0");
				Horn.getComp("account_content").setValue(idInfo.id_no, true) ;
				readIDCard();
				//流水信息记录
				var params =  idInfo;
				params.issued_depart = idInfo.grant_organ;
				params.id_nation = idInfo.nation;
				Horn.post('/switchField/recordIdCardReadHis.json',idInfo,function(data){
					if(!data||'false'==data){
						alert('身份证读卡器流水记录失败');
					}
				});
			}
		);
		reader.start() ;
	}else{
		if(reader!=null){
			reader.stop();
		}
	}
}
</script>


								<li class="hc_panel-li "><span title="客户代码"> <b
										class="hc_red">*</b> 客户代码</span>
									<div class="hc_combox" pKeyField=pLabel keyField=label
										titleField=value showLabel="false">
										<input type="hidden" name="client_id" check="required;" />
										<input multiple="" type="text" onchange="changeClientId(this)"
											readonly="readonly" delimiter="," />

										<div class="hc_checkboxdiv" multiple_line="false">
											<ul>

											</ul>
										</div>
									</div>
									<div style="display:none;"></div></li>

								<li class="hc_panel-li "><span title="资金账户"> <b
										class="hc_red">*</b> 资金账户</span>
									<div class="hc_combox" pKeyField=pLabel keyField=label
										titleField=value showLabel="false">
										<input type="hidden" name="busin_account" check="required;" />
										<input multiple="" type="text"
											onchange="changeBusinAccount(this)" readonly="readonly"
											delimiter="," />

										<div class="hc_checkboxdiv" multiple_line="false">
											<ul>

											</ul>
										</div>
									</div>
									<div style="display:none;"></div></li>



								<input type="hidden" name="branch_no" value="" />
								<input type="hidden" name="businsys_id" value="" />
								<input type="hidden" name="busin_businsys_id" value="" />
								<input type="hidden" name="cif_account" value="" />
								<input type="hidden" name="organ_flag" value="" />
								<input type="hidden" name="image_up_flag" value="" />
								<input type="hidden" name="init_date" value="20161011" />
								<input type="hidden" name="aixiliary_check" value="" />

								<input type="hidden" name="fund_account" value="" />

								<script type="text/javascript">
	var clientData = [];
	var businData = [];
	var stockData = [];
	var switchFieldPayData = {};
	var switchFieldPayCifResult = {};
	var switchFieldClientData = {};
	var client_id_flag = "0";	// 状态正常的客户代码标识
	var busin_account_flag = "0";	// 状态正常的资金账户标识
	var stock_account_flag = "0";	// 状态正常的理财资金账户标识
	var cif_branch_no = "";
    var retainClientStatus = "0".split(",");	// 界面传入，需要保留的客户代码状态，默认是正常状态 0
    var retainBusinStatus = "0".split(",");		// 界面传入，需要保留的资金账户状态，默认是正常状态 0
    var retainStockStatus = "0".split(",");		// 界面传入，需要保留的证券账户状态，默认是正常状态 0
    
    Horn.ready(function(){
    		});
	var secu = {
		comSuccess:function(cifResult){
			var form = Horn.getComp("bundlenewcardForm");
			if(cifResult){
				switchFieldPayCifResult=cifResult;
				if(cifResult.cifacct_status!=0){
					alert('一户通号: '+cifResult.cif_account+'  状态: '+cifResult.cifacct_status_name+', 不能进行此业务!');
					Horn.getComp('account_content').setValue("");
					Horn.getComp('account_content').field.focus();
				}else{
					// 个人15位身份证升位判断
											// 个人客户，一户通对应身份证号为15位，需先去升位
						if(cifResult.organ_flag == "0" && cifResult.id_kind == "0" && cifResult.id_no && cifResult.id_no.length == 15){
							alert("系统中该客户身份证号是15位的，需要去“一户通”-“联合修改”-“身份证号升位”菜单做身份证号升位！");
							clearCommonData();
					    	return;
						}
										// 默认显示客户代码信息，不加载一户通信息
																Horn.Field.setValue("remark", "");
										Horn.Field.setValue("cif_account", cifResult.cif_account);
					Horn.Field.setValue("organ_flag", cifResult.organ_flag);
					Horn.Field.setValue("branch_no", cifResult.branch_no);
					cif_branch_no = cifResult.branch_no;
					//银行身份信息修改
										// 加载客户代码之前执行
										// 加载客户代码
											// 判断是否启用客户代码显示控制
						var hideClientFlag = "";
						if(cifResult.organ_flag != $.trim(hideClientFlag)){
							getClientId(cifResult.cif_account, cifResult.organ_flag);
							// 没有查询到客户代码
							if(client_id_flag == "0"){	// 不存在或是没有状态正常的客户代码
								// 清数据
								clearCommonData();
								return;
							}
							// 客户代码切换
							changeClientId();
						}
										// ----------------- 下面是引用界面自定义方法的实现 ------------------
					// 一户通号切换后处理
										
				}
			}else{
			    clearCommonData();
				Horn.getComp('account_content').setValue("");
				Horn.getComp('account_content').field.focus();
			}
			
						
		},
		comFailure:function(cifResult){
			clearCommonData();
			var error = Horn.getError(cifResult) ;
			alert(error) ;
		}
	};
	/**
	 * 获取客户代码
	 */
	function getClientId(cif_account, organ_flag){
		var params = {"cif_account":cif_account};
				params["asset_prop"] = Horn.Field.getValue("asset_prop");
		// 不过滤销户账户
				// 显示客户代码的子系统
					params["businsys_id"] = 75;
				Horn.getComp('client_id').clearList();
		Horn.post("/iwm/secu/common/getClientId.json",params,
	        function(clientResult){
	            if(clientResult && clientResult.length > 0){
	            	switchFieldClientData = {};
			        var list = [];
			        var client_id_first = "";
			        var getFirstClientId = true;
			        var isExistClientId = false;
			        // 缓存客户代码列表，切换客户代码时使用
			        clientData = clientResult;
            		for(i=0;i<clientResult.length;i++){
            			if(retainClientStatus[0] == "all" || $.inArray(clientResult[i].client_status, retainClientStatus) >= 0){
            				// 获取第一个状态正常或者符合要求的客户代码
        					if(getFirstClientId){
        						// 个人客户，获取身份证号为18位的正常客户代码
        						if(organ_flag == "0"){
        							        								// 个人，非身份证号，不判断证件长度
        								// 个人，身份证号，18位，不判断证件长度
            							if((clientResult[i].id_kind != "0") || (clientResult[i].id_kind == "0" && clientResult[i].id_no && $.trim(clientResult[i].id_no).length == 18)){
            								client_id_first = clientResult[i].client_id;
            								Horn.Field.setValue("branch_no", clientResult[i].branch_no);
            								Horn.Field.setValue("businsys_id", clientResult[i].businsys_id);
            								getFirstClientId = false;
            							}else{
            								// 个人，身份证号，15位，判断证件长度
            							}
        							        						}else{	// 机构，不判断证件长度
        							client_id_first = clientResult[i].client_id;
    								Horn.Field.setValue("branch_no", clientResult[i].branch_no);
    								Horn.Field.setValue("businsys_id", clientResult[i].businsys_id);
    								getFirstClientId = false;
        						}
        					}
        					isExistClientId = true;
        				}
            			switchFieldClientData = clientResult;
            			Horn.Field.setValue("aixiliary_check", clientResult[0].check);//转账辅账判断扁平化是否报错
        				var singleData = {"value":clientResult[i].client_id+"("+clientResult[i].branch_no_name+")","label":clientResult[i].client_id};
        				list.push(singleData);
            		}
            		client_id_flag = "2";
            		// 存在状态正常的客户代码
            		if(isExistClientId){
            			// 个人15位身份证升位判断
            				            			// 状态正常的客户代码，但身份证号都为15位
	            			if(organ_flag == "0" && $.trim(client_id_first) == ""){
	            				client_id_flag = "0";
	            				alert("该客户的客户代码对应身份证号是15位，需要去“一户通”-“联合修改”-“身份证号升位”菜单做身份证号升位！");
	            				return;
	            			}
            			            		}else{
            			client_id_flag = "0";
						alert("没有状态正常的客户代码");
						return;
            		}
					Horn.getComp("client_id").addDatas(list,true);
											Horn.getComp("client_id").setValue(client_id_first);
								    }else{
			    	client_id_flag = "0";
			    	alert("未查询到客户代码");
			    	return;
			    }
	        },
	        function(clientResult){
	    		var error = Horn.getError(clientResult) ;
	    		client_id_flag = "0";
				alert(error) ;
	    	},
	        null,false);
	}
	
	/**
	 * 客户代码切换
	 */
	function changeClientId(){
		var client_id = Horn.Field.getValue("client_id");
		var cif_account = Horn.Field.getValue("cif_account");
				// 加载界面时，如果客户代码为空，不再继续执行
		if(!client_id || $.trim(client_id) == ""){
			return;
		}
		var organ_flag = Horn.Field.getValue("organ_flag");
		var client_status = "";
		var id_no_15 = "";
		for(i=0; i<clientData.length; i++){
			// 获取选中的客户代码状态
            if(client_id == clientData[i].client_id){
            	var branch_Auxili=clientData[i].branch_no;
            	if(retainClientStatus[0] != "all" && $.inArray(clientData[i].client_status, retainClientStatus) < 0){
            		client_status = clientData[i].client_status_name;
            		break;
            	}
            	Horn.Field.setValue("branch_no", clientData[i].branch_no);
            	Horn.Field.setValue("id_no", clientData[i].id_no);
            	/**
        		 * 君行天下密码校验
        		 */
        		var check_flag = Horn.Field.getValue("check_flag");
        		var action_Type_No1 = Horn.Field.getValue("action_Type_No1");
        		var jxtxbranch_no = clientData[i].branch_no;
        		var jxtx_fllow_flag_type = Horn.Field.getValue("jxtx_fllow_flag_type");
        		var menu_id = Horn.Util.getParamValue("menu_id") ;
        		var hsMune_Type=Horn.Field.getValue("hsMune_Type0");
        		var cif_account_jxtx=Horn.Field.getValue("cif_account");
        		var branch_no_jxtx=Horn.Field.getValue("branch_no");
        		var gt_menu_type0=Horn.Field.getValue("gt_menu_type0");
        		var gt_menu_type1=Horn.Field.getValue("gt_menu_type1");
        		var organ_flag_status0=Horn.Field.getValue("organ_flag_status0");
        		var organ_flag_status1=Horn.Field.getValue("organ_flag_status1");
        		var organ_flag=Horn.Field.getValue("organ_flag");
        		var jxtxret=true;
        		var jxtxcheck=true;
        		/**
        		 * 判断当前操作员是否能够操作当前客户代码
        		 */
                	Horn.post("/iwm/secu/common/getClientCheckIdByCifAccount.json",{"cif_account":cif_account_jxtx,"client_id":client_id,"branch_no":branch_no_jxtx,"gt_menu_type0":gt_menu_type0,"gt_menu_type1":gt_menu_type1,"organ_flag_status0":organ_flag_status0,"organ_flag_status1":organ_flag_status1,"organ_flag":organ_flag},function(data){
                		if(data=="0"){
                			alert("客户需通过君行天下办理此业务");
                			/**
                    		 * 君行天下密码校验
                    		 */                			
                			Horn.Field.setValue("check_flag", "1");
                    		var jxtxbranch_no = Horn.Field.getValue("jxtxbranch_no");
                    		var hsMune_Type = Horn.Field.getValue("hsMune_Type0");
                    		var jxtx_fllow_flag_type = Horn.Field.getValue("jxtx_fllow_flag_type");
                    		var jxtx_fllow_flag_type1 = Horn.Field.getValue("jxtx_fllow_flag_type1");
                    		var organ_flag_jxtx = Horn.Field.getValue("organ_flag");
                    		var menu_id = Horn.Util.getParamValue("menu_id") ;
                    			if(organ_flag_jxtx=="0"){
                    				if(action_Type_No1!="0"){//证明不是读卡的
                    					if(hsMune_Type=="3"){
                    						alert("该操作必须要通过刷身份证完成");
                    						Horn.getComp("account_content").setValue("", true) ;
                    						Horn.getComp("client_id").setValue("", true) ;
                    						Horn.getComp("busin_account").setValue("", true) ;
                    						Horn.hideMask() ;
                    						jxtxcheck=false;
                    					}else if (hsMune_Type=="1"||hsMune_Type=="2"){
                    						var jxtxret =Iwm.Pwd.jxtxCheckPwdCommon(menu_id,jxtx_fllow_flag_type,cif_account,client_id,null,branch_no_jxtx,null);
                    						jxtxcheck=jxtxret;
                    					}
                    				}else if (action_Type_No1!="1"){//证明这是刷卡的
                    					if(hsMune_Type=="2"){
                    						var jxtxret =Iwm.Pwd.jxtxCheckPwdCommon(menu_id,jxtx_fllow_flag_type,cif_account,client_id,null,branch_no_jxtx,null);
                    						jxtxcheck=jxtxret;
                    					}
                    				}
                    			}else {
                    				var jxtxret =Iwm.Pwd.jxtxCheckPwdCommon(menu_id,jxtx_fllow_flag_type1,cif_account,client_id,null,branch_no_jxtx,null);
            						jxtxcheck=jxtxret;
                    			}
                		}else if(data=="1"){
                			Horn.Field.setValue("check_flag", "0");
                		}
                	},function(data){
                		jxtxcheck=false;
                		alert(data.errorInfo);
                		clearCommonData();
                	},null,false);
                	if(!jxtxcheck){
                		Horn.getComp("client_id").setValue("");
                		return;
                	}
            	            		Horn.Field.setValue("id_kind", clientData[i].id_kind);
            		Horn.Field.setValue("full_name", clientData[i].full_name);
            	            	Horn.Field.setValue("businsys_id", clientData[i].businsys_id);
            		            	// 个人客户代码状态正常，但是对应身份证号是15位
	            	if(organ_flag == "0" && clientData[i].id_kind == "0" && clientData[i].id_no && $.trim(clientData[i].id_no).length == 15){
	            		id_no_15 = clientData[i].id_no;
	            		break;
	            	}
            	            	// 界面显示AC对应的信息
            	            		Horn.Field.setValue("branch_no1", clientData[i].branch_no);
            		Horn.Field.setValue("branch_no_name", clientData[i].branch_no_name);
            		Horn.Field.setValue("full_name1", clientData[i].full_name);
            		Horn.Field.setValue("client_name", clientData[i].client_name);
            		Horn.Field.setValue("client_name1", clientData[i].client_name);
            		Horn.Field.setValue("organ_flag_name", clientData[i].organ_flag_name);
            		Horn.Field.setValue("id_kind_name", clientData[i].id_kind_name);
            		Horn.Field.setValue("id_no1", clientData[i].id_no);
            		Horn.Field.setValue("custacct_type_name", clientData[i].custacct_type_name);
            		Horn.Field.setValue("custacct_group_name", clientData[i].custacct_group_name);
            		Horn.Field.setValue("cust_property_name", clientData[i].cust_property_name);
            		Horn.Field.setValue("client_status_name", clientData[i].client_status_name);
            		Horn.Field.setValue("corp_risk_level_name", clientData[i].corp_risk_level_name);
            		Horn.Field.setValue("nationality_name", clientData[i].nationality_name);
            		Horn.Field.setValue("client_gender", clientData[i].client_gender);
            	            }
		}
		
		// 不合格账户判断
				
		if($.trim(client_status) != ""){
			alert("该客户代码状态不正常:" + client_status);
			Horn.Field.setValue("client_id", "");
			clearCommonData("AC");
			return;
		}
		// 个人15位身份证升位判断
					if($.trim(id_no_15) != ""){
				alert("客户代码:"+client_id+"对应身份证号是15位，需要去“一户通”-“联合修改”-“身份证号升位”菜单做身份证号升位！");
				Horn.Field.setValue("client_id", "");
				clearCommonData("AC");
				return;
			}
				// 客户代码切换后获取资金账户前处理
				// 加载资金账户
					loadBusinAccount();
			// 不存在状态正常的资金账户
			if(busin_account_flag == "0"){
				clearCommonData("AF");
				return;
			}
			// 资金账户切换
			changeBusinAccount();
				
		// 显示客户代码，通过客户代码查询代理人
				
		//加载资产账户
				
		
		// ----------------- 下面是引用界面自定义方法的实现 ------------------
		// 客户代码切换后处理
				
		// 自动加载表格数据
				
	}
	
	/**
	 * 加载资金账户模板
	 */
	function loadBusinAccountModel(){
		var branch_no = Horn.Field.getValue("branch_no");
		Horn.post("/iwm/credit/credit/loadBusinTemplate.json",{"branch_no":branch_no},function(data){
			Horn.getComp("businAccount.gt_azjmb").addDatas(data.gt_azjmb,true);
			Horn.getComp("businAccount.busiacct_type").addDatas(data.busiacct_type,true);
			Horn.getComp("businAccount.busiacct_room").addDatas(data.busiacct_room,true);
			Horn.getComp("businAccount.busiacct_group").addDatas(data.busiacct_group,true);
			Horn.getComp("businAccount.money_type").addDatas(data.money_type,true);
			Horn.getComp("businAccount.rate_kind").addDatas(data.rate_kind,true);
			Horn.getComp("businAccount.en_entrust_way").addDatas(data.en_entrust_way,true);
			Horn.getComp("businAccount.busiacct_agent_rights").addDatas(data.busiacct_agent_rights,true);
			Horn.getComp("businAccount.busin_rights").addDatas(data.busin_rights,true);
			Horn.getComp("businAccount.busin_restriction").addDatas(data.busin_restriction,true);
			Horn.getComp("businAccount.busiacct_trade_rights").addDatas(data.busiacct_trade_rights,true);
		},function(data){
			var error = Horn.getError(data) ;
			alert(error) ;
		},null,false);
	}
	
	/**
	 * 普通信用切换
	 */
	function changeAssetProp(){
		// 加载资金账户
					loadBusinAccount();
			// 不存在状态正常的资金账户
			if(busin_account_flag == "0"){
				clearCommonData("AF");
				return;
			}
			// 资金账户切换
			changeBusinAccount();
			}
	
	/**
	 * 获取资金账户
	 */
	function loadBusinAccount(){
		var client_id = Horn.Field.getValue("client_id");
		var businsys_id = Horn.Field.getValue("businsys_id");
		if(!client_id || $.trim(client_id) == ""){
			return;
		}
		var params = {"client_id":client_id};
		// 显示资金账号的子系统
					params["businsys_id"] = 75;
				// 显示普通资金账户（默认显示）
					params["retainGeneral"] = true;
				// 显示信用资金账户（默认不显示）
				// 显示期权资金账户（默认不显示）
				// 过滤辅资金账户（默认不过滤）
				// 不过滤销户账户（默认过滤）
				/*
		 * 方臻 **2015.08.20 增加过滤资金账户方法
		 */
		// 过滤资金账户（默认不过滤）
				
				Horn.getComp('busin_account').clearList();
		Horn.post("/iwm/secu/common/getBusinAccount.json",params,
			function(businResult){
				if(businResult && businResult.length > 0){
					businData = businResult;
			        var list = [];
			        var busin_account_first = "";
			        var getFirstBusinAccount = true;
			        var isExistBusinAccount = false;
	        		for(i=0;i<businResult.length;i++){
	        			// 获取第一个状态正常或是符合要求的资金账户
	        			if(retainBusinStatus[0] == "all" || $.inArray(businResult[i].businacct_status, retainBusinStatus) >= 0){
	        				if(getFirstBusinAccount){
	        					busin_account_first = businResult[i].busin_account;
	        					Horn.Field.setValue("fund_account",businResult[i].fund_account);
								getFirstBusinAccount = false;
	        				}
	        				isExistBusinAccount = true;
	        			}
	        			var singleData = {"value":businResult[i].busin_account,"label":businResult[i].busin_account};
        			    list.push(singleData);
	        		}
	        		busin_account_flag = "2";
	        		Horn.getComp("busin_account").addDatas(list,true);
	        		// 存在状态正常的资金账户
            		if(!isExistBusinAccount){
            			busin_account_flag = "0";
						alert("没有状态正常的资金账户");
						return;
            		}
            								Horn.getComp("busin_account").setValue("");
								    }else{
			       busin_account_flag = "0";
			       alert("未查询到资金账户");
				   return;
			    }
	        },
	        function(businResult){
	     		var error = Horn.getError(businResult) ;
	     		busin_account_flag = "0";
	 			alert(error) ;
	     	},
	        null,false);
	}
	
	/**
	 * 资金账户切换
	 */
	function changeBusinAccount(){
		var busin_account = Horn.Field.getValue("busin_account");
		if( !busin_account || $.trim(busin_account) == "" ){
			return;
		}
		var businacct_status = "";
		for(i=0; i<businData.length; i++){
			// 获取选中的资金账户状态
            if(busin_account == businData[i].busin_account){
            	if(retainBusinStatus[0] != "all" && $.inArray(businData[i].businacct_status, retainBusinStatus) < 0){
            		businacct_status = businData[i].businacct_status_name;
            		break;
            	}
            	// 选中的资金账户主辅标识
            	Horn.Field.setValue("main_flag",businData[i].main_flag);
            	Horn.Field.setValue("fund_account",businData[i].fund_account);
            	Horn.Field.setValue("busin_businsys_id",businData[i].businsys_id);
            }
		}
		if($.trim(businacct_status) != ""){
			alert("该资金账户状态不正常:" + businacct_status);
			Horn.Field.setValue("busin_account", "");
			clearCommonData("AF");
			return;
		}
		// 加载证券账户，市场类别exchange_type不显示时，默认加载证券账户；显示市场类别，切换exchange_type时，再加载证券账户
									
		// ------------- 下面是引用界面自定义方法的实现 -----------------
		// 资金账户切换后处理
					newcard.businessAccountChange();
				
	}
	
	/**
	 * 加载交易市场类别列表
	 */
	function loadExchangeType(exchange_types){
		if(!exchange_types){
			exchange_types = "";
		}
		Horn.post("/iwm/secu/common/getExchangeTypes.json",{"exchange_types":exchange_types},
			function(exchangeTypesResult){
				var list = [];
				if(exchangeTypesResult && exchangeTypesResult.length > 0){
					for ( var e = 0; e < exchangeTypesResult.length; e++) {
						var singleData = {"value":exchangeTypesResult[e].value,"label":exchangeTypesResult[e].label};
						list.push(singleData);
					}
					Horn.getComp("exchange_type").addDatas(list,true);
				}
	        },
	        function(exchangeTypesResult){
	     		var error = Horn.getError(exchangeTypesResult) ;
	 			alert(error) ;
	     	},
	        null,false);
	}
	
	/**
	 * 一码通切换
	 */
	function changeAcodeAccount(){
		// ------------- 下面是引用界面自定义方法的实现 -----------------
		// 一码通切换后处理
			}
	/**
	 * 交易市场切换
	 */
	function changeExchangeType(){
		// 交易市场切换后处理
				var exchange_type = Horn.Field.getValue("exchange_type");
		if(!exchange_type || exchange_type == ""){
			return;
		}
				// ------------- 下面是引用界面自定义方法的实现 -----------------
		// 交易市场切换后处理
			}
	/**
	 * 查询中登证券账户
	 */
	function loadCSDCStockAccount(){
		
	}
	/**
	 * 查询本地证券账户
	 */
	function loadNativeStockAccount(){
		var busin_account = Horn.Field.getValue("busin_account");
		if(!busin_account || $.trim(busin_account) == ""){
			return;
		}
		Horn.getComp("stock_account").clearList();
		var exchange_type = Horn.Field.getValue("exchange_type");
		var businsys_id = Horn.Field.getValue("busin_businsys_id");
		var params = {"busin_account":busin_account, "exchange_type":exchange_type, "businsys_id":businsys_id};
		Horn.post("/iwm/secu/common/getStockAccount.json",params,
			function(stockResult){
				if(stockResult && stockResult.length > 0){
					stockData = stockResult;
			        var list = [];
			        var stock_account_first = "";
			        var getFirstStockAccount = true;
			        var isExistStockAccount = false;
	        		for(i=0;i<stockResult.length;i++){
	        			if(retainStockStatus[0] == "all" || $.inArray(stockResult[i].holder_status, retainStockStatus) >= 0){
	        				// 获取第一个状态正常或者符合要求的证券账户
	        				if(getFirstStockAccount){
	        					stock_account_first = stockResult[i].stock_account;
								getFirstStockAccount = false;
	        				}
	        				isExistStockAccount = true;
	        			}
	        			var singleData = {"value":stockResult[i].stock_account,"label":stockResult[i].stock_account};
        			    list.push(singleData);
	        		}
	        		stock_account_flag = "2";
	        		Horn.getComp("stock_account").addDatas(list,true);
	        		// 存在状态正常的证券账户
            		if(!isExistStockAccount){
            			stock_account_flag = "0";
            			            				alert("没有状态正常的证券账户");
            									return;
            		}
					Horn.getComp("stock_account").setValue(stock_account_first);
			    }else{
			    	stock_account_flag = "0";
			    	alert("未查询到证券账户");
			    	return;
			    }
	        },
	        function(stockResult){
	     		var error = Horn.getError(stockResult) ;
	     		stock_account_flag = "0";
	 			alert(error) ;
	     	},
	        null,false);
	}
	
	/**
	 * 查询本地证券账户
	 */
	function loadDistribStockAccount(){
		var busin_account = Horn.Field.getValue("busin_account");
		if(!busin_account || $.trim(busin_account) == ""){
			return;
		}
		Horn.getComp("stock_account").clearList();
		var exchange_type = Horn.Field.getValue("exchange_type");
		var businsys_id = Horn.Field.getValue("busin_businsys_id");
		var client_id = Horn.Field.getValue("client_id");
		var params = {"client_id":client_id, "exchange_type":exchange_type, "businsys_id":businsys_id};
		Horn.post("/iwm/secu/common/getStockAcctByClientId.json",params,
			function(stockResult){
				if(stockResult && stockResult.length > 0){
					stockData = stockResult;
			        var list = [];
			        var stock_account_first = "";
			        var getFirstStockAccount = true;
			        var isExistStockAccount = false;
	        		for(i=0;i<stockResult.length;i++){
	        			if(retainStockStatus[0] == "all" || $.inArray(stockResult[i].holder_status, retainStockStatus) >= 0){
	        				// 获取第一个状态正常或者符合要求的证券账户
	        				if(getFirstStockAccount){
	        					stock_account_first = stockResult[i].stock_account;
								getFirstStockAccount = false;
	        				}
	        				isExistStockAccount = true;
	        			}
	        			var singleData = {"value":stockResult[i].stock_account,"label":stockResult[i].stock_account};
        			    list.push(singleData);
	        		}
	        		stock_account_flag = "2";
	        		Horn.getComp("stock_account").addDatas(list,true);
	        		// 存在状态正常的证券账户
            		if(!isExistStockAccount){
            			stock_account_flag = "0";
            			            				alert("没有状态正常的证券账户");
            									return;
            		}
					Horn.getComp("stock_account").setValue(stock_account_first);
			    }else{
			    	stock_account_flag = "0";
			    	alert("未查询到证券账户");
			    	return;
			    }
	        },
	        function(stockResult){
	     		var error = Horn.getError(stockResult) ;
	     		stock_account_flag = "0";
	 			alert(error) ;
	     	},
	        null,false);
	}
	
	/**
	 * 证券账户切换
	 */
	function changeStockAccount(){
		var stock_account = Horn.Field.getValue("stock_account");
		if( !stock_account || $.trim(stock_account) == "" ){
			return;
		}
		var holder_status = "";
		for(i=0; i<stockData.length; i++){
			// 获取选中的资金账户状态
            if(stock_account == stockData[i].stock_account){
            	if(retainStockStatus[0] != "all" && $.inArray(stockData[i].holder_status, retainStockStatus) < 0){
            		holder_status = stockData[i].holder_status_name;
            		break;
            	}
            }
		}
		if($.trim(holder_status) != ""){
			alert("该证券账户状态不正常:" + holder_status);
			Horn.Field.setValue("stock_account", "");
			return;
		}
		
		// ------------- 下面是引用界面自定义方法的实现 -----------------
		// 证券账户切换后处理
				
	}
	
	/**
	 * 提交表单
	 * @param commonCheckPwd 是否需要校验密码：0 不校验；1或不传 校验。需配合checkCifPwd和function_id使用
	 */
	function pageSubmit(commonCheckPwd){
		var cif_account = Horn.Field.getValue("cif_account");
		var client_id = "";
		var busin_account = "";
		var client_branch_no = "";
					client_id = Horn.Field.getValue("client_id");
			client_branch_no = Horn.Field.getValue("branch_no");
							busin_account = Horn.Field.getValue("busin_account");
				
		var menu_id_type1 = Horn.Util.getParamValue("menu_id") ;
		if(menu_id_type1=="591103"||menu_id_type1=="170305"){
			if(passwordHidden=="0"){
				Horn.getComp("fund_password").setNotRequired();
			}
		}
		
		var form = Horn.getComp("bundlenewcardForm");
		if(Horn.Validate.isFormValidate(form)){
							form.submit();
					}
	}
	
	/**
	 * 清空数据
	 * @param flag：AC，AF
	 */
	function clearCommonData(flag){
    	var form = Horn.getComp("bundlenewcardForm") ;
    	if(!flag){
    		form.setValues({'account_content':'','cif_account':'','organ_flag':'','branch_no':'','businsys_id':'','busin_businsys_id':'','fund_account':'','init_date':''});
    	}
    	if(!flag || flag == "AC"){
    		form.setValues({"branch_no1":"", "branch_no_name":"", "full_name1":"", "client_name":"", "organ_flag_name":"", "id_kind_name":"", "id_no":"", "id_no1":"", 
        		"custacct_type_name":"", "custacct_group_name":"", "cust_property_name":"", "client_status_name":"", "cancel_reason":"", "remark":""});
    	}
    	form.setValues({"isOpenStockAccount":""});
					if(!flag){
				Horn.getComp('client_id').clearList();
			}
									if(!flag || flag == "AC"){
				Horn.getComp('busin_account').clearList();
			}
															}
	
	
	//获取资产账户
	function getAsset_account(){
		var client_id = Horn.Field.getValue("client_id");
		var branch_no = Horn.Field.getValue("branch_no");
		var cif_account = Horn.Field.getValue("cif_account");
		var businsys_id = Horn.Field.getValue("businsys_id");
		var param = {"client_id":client_id,"branch_no":branch_no,"cif_account":cif_account,"businsys_id":businsys_id};
		var fundAccountUrl = '';
		if("bundlenewcardForm" == "passwordSet_form"){
			fundAccountUrl = 'http://10.176.108.50:8080/biz-iwm/pay/cf/findFundAccounts.json';
		}else{
			fundAccountUrl = 'http://10.176.108.50:8080/biz-iwm/pay/cf/findPayFundAccounts.json';
		}
		Horn.post(fundAccountUrl,param,          
		    function(fund_data) { 
			    if(fund_data){
			    	fundAccountArray = fund_data;
			    	switchFieldPayData.fundAccountInfo = fund_data[0];
		    		addPayFundAccountSelectOption(fund_data);
		    		//获取客户代码
		    		//getClientId(cif_data.cif_account);
			     }
			},
			function(data){					
									var failure = "newcard.failure" ;
					failure = Horn.Util.getFunObj(failure).fn ;
								if(data.errorNo && data.errorNo!='0'){
					var error = Horn.getError(data) ;
					if(jQuery.isFunction(failure)){
						clearPayFundAccountSelectOption();
						failure.call(this,data) ;
					}
					else{
						alert(error) ;
					}
				}
			}
		);
		
	}
	function addPayFundAccountSelectOption (data){
		clearPayFundAccountSelectOption();
		if(data){
			if(data.length > 0){
				var i = 0;
				var dataArray = new Array();
				for(i in data){	
					dataArray.push({"label":data[i].busin_account,"value":data[i].busin_account+"("+data[i].branch_no_name+")"});
				}
				var fAccount = Horn.getComp("asset_account") ;
				fAccount.addDatas(dataArray);
//				fAccount.selectFirst();
				$(document).trigger("click") ;
				fAccount.field.trigger("focus") ;
			}
		}
	}
	
	function pay_switch_field_events(obj){
		
					var success = jQuery.noop ;
				var i = 0;
		for(i in fundAccountArray){
		    var fund_account = Horn.getComp("asset_account").getValue();
			if(fund_account==fundAccountArray[i].busin_account){//海外和外汇子系统使用
			     Horn.Field.setValue("businsys_id",fundAccountArray[i].businsys_id);
			}
			var objValue=obj.value;
			objValue=objValue.substring(0, objValue.lastIndexOf('('));
			
			//切换资产账号校验密码前执行
						
			if(objValue == fundAccountArray[i].busin_account){
				/**
				 * 君行天下密码校验
				 */
				var check_flag = Horn.Field.getValue("check_flag");
        		var jxtx_fllow_flag_type = Horn.Field.getValue("jxtx_fllow_flag_type");
        		var menu_id = Horn.Util.getParamValue("menu_id") ;
        		var hsMune_Type=Horn.Field.getValue("hsMune_Type0");
        		var action_Type_No1=Horn.Field.getValue("action_Type_No1");
        		var jxtxbranch_no=fundAccountArray[i].branch_no;
        		var jxtxret=true;
        		if(check_flag=="1"){
        			if(hsMune_Type=="2"){
        				var jxtxret =Iwm.Pwd.jxtxCheckPwd(menu_id,jxtx_fllow_flag_type,null,null,objValue,jxtxbranch_no,null);
        			}else{
        				if(hsMune_Type=="1"){
        					if(action_Type_No1!="0"){
        						var jxtxret =Iwm.Pwd.jxtxCheckPwd(menu_id,jxtx_fllow_flag_type,null,null,objValue,jxtxbranch_no,null);
        					}
        				}else{
        					if(action_Type_No1!="0"){
        						var jxtxret =Iwm.Pwd.jxtxCheckPwd(menu_id,jxtx_fllow_flag_type,null,null,objValue,jxtxbranch_no,null);
        					}
        				}
        			}
        		}
        		if(jxtxret){
        			
        		}else{
        			Horn.getComp('asset_account').setValue("");
        			return;
        		}
				switchFieldPayData.fundAccountInfo = fundAccountArray[i];
			}
			
			//如果是走君行天下的话那就必须在校验完资金账户以后才能去获取影像
						
		}
		success.call(this,switchFieldPayData);
	}
	
function clearPayFundAccountSelectOption(){		
	Horn.getComp("asset_account").clearList();
}
	
</script>


								<input type="hidden" name="jxtx_fllow_flag_type" value="0" />
								<input type="hidden" name="gt_instgdrctpty" value="7103200003" />
								<input type="hidden" name="business_no" value="" />
								<input type="hidden" name="position_str" value="" />
								<input type="hidden" name="id_no" value="" />
								<input type="hidden" name="id_kind" value="" />
								<input type="hidden" name="full_name" value="" />

								<li class="hc_panel-li h_licols-2"><span title="开户银行">
										开户银行</span>
									<div class="hc_combox" pKeyField=pLabel keyField=label
										titleField=value showLabel="false">
										<input type="hidden" name="gt_ztbank_no" check="" /> <input
											multiple="" type="text" disabled="disabled"
											readonly="readonly" delimiter="," />

										<div class="hc_checkboxdiv" multiple_line="false">
											<ul>

											</ul>
										</div>
									</div>
									<div style="display:none;"></div></li>
								<li class="hc_panel-li h_licols-2"><span title="旧银行帐号">
										旧银行帐号</span>
									<div class="hc_textfield">
										<input type="text" name="old_bank_account" maxlength=""
											value="" disabled="disabled" check="" />
									</div>
									<div style="display:none;"></div></li>
								<li class="hc_panel-li h_licols-2"><span title="新银行帐号">
										<b class="hc_red">*</b> 新银行帐号</span>
									<div class="hc_textfield">
										<input type="text" name="bank_account" maxlength="" value=""
											onblur="" check="required;newcard_check_bank_account;" />
									</div>
									<div style="display:none;"></div></li>
								<li class="hc_panel-li h_licols-2"><span title="确认银行帐号">
										<b class="hc_red">*</b> 确认银行帐号</span>
									<div class="hc_textfield">
										<input type="text" name="re_bank_account" maxlength=""
											value="" onblur=""
											check="required;newcard_check_re_bank_account;" />
									</div>
									<div style="display:none;"></div></li>
								<li class="hc_panel-li "><span title="银行预留手机"> <b
										class="hc_red">*</b> 银行预留手机</span>
									<div class="hc_textfield">
										<input type="text" name="mobiletelephone" maxlength=""
											value="" check="required;newcard_check_mobiletelephone;" />
									</div>
									<div style="display:none;"></div></li>
								<li class="hc_panel-li "><span title="短信验证码"><b
										class=hc_red>*</b>短信验验证码</span>
									<div class="hc_textfield">
										<input type="text" name="gt_msgChkNo" check="required;"
											onkeydown='' style="width:90px;"><button id="msgBtn"
												class="msg-btn" onclick="newcard.getMessageCode()">获取</button>
									</div>
									<div style="display:none;"></div>
									<li>
										<li class="hc_panel-li "><span title="支付密码"> <b
												class="hc_red">*</b> 支付密码</span>
											<div class="hc_password">
												<input type="password" name="password2" maxlength=""
													value="" onblur="newcard.password.check()"
													check="required;length(6,8);" />
											</div>
											<div style="display:none;"></div></li>
							</ul>
						</div>
					</div>

					<div class="h_colspan-2" style="height:210px;" name="_colspan">
						<div class=" userborderR userborderB" style="height:209px;"
							name="_border">
							<ul class="h_panel" name="">
								<div style="width:300px;margin-left:auto;margin-right:auto;">
									<img id="idcard_img" src="../../css/user/img/nophoto_03.gif"
										width="120" /> <img id="scan_img"
										src="../../css/user/img/nophoto_03.gif" width="120" />
								</div>
								<div class="h_colspan-3">
									<div class="h_btndiv" name="">
										<button type="button" name="" class="h_btn-submit btn-left"
											onclick="newcard.getGAIDInfo()">公安信息</button>
										<button type="button" name="" class="h_btn-submit btn-right"
											onclick="newcard.scanImage()">拍照</button>
									</div>
								</div>


							</ul>
						</div>
					</div>
					<div class="h_colspan-3">
						<div class="check-alt" onselectstart="return false">
							<div id="step1" class="default">
								<span class="text">1开始换卡</span>
							</div>
							<div>───</div>
							<div id="step2" class="default">
								<span class="text">2银行卡验证</span>
							</div>
							<div>───</div>
							<div id="step3" class="default">
								<span class="text">3综合理财换卡</span>
							</div>
							<div>───</div>
							<div id="step4" class="default">
								<span class="text">4资管换卡</span>
							</div>
							<div>───</div>
							<div id="step5" class="default">
								<span class="text">5换卡成功</span>
							</div>
						</div>

					</div>
					<div class="h_colspan-3">
						<div class="h_btndiv" name="">
							<button type="button" name="" class="submitBtn"
								onclick="newcard.submit()">提交</button>
							<button type="button" name="" class="resetBtn"
								onclick="newcard.reset(true)">重置</button>
						</div>
					</div>
				</form>


			</div>
			<div class="h_floatdiv" name="scanFinish_window" h_height="120"
				h_width="220" style="display:none">
				<div class="h_floatdiv-title">
					<span>图片采集</span> <a href="#">X</a>
				</div>
				<div class="h_floatdiv-con">
					<div style="margin:10px;">正在进行客户头像图片采集，采集完成请点击“确定”按钮。</div>
					<div class="h_colspan-3">
						<div class="h_btndiv" name="">
							<button type="button" name="" class="scan-finish-btn"
								onclick="newcard.scanFinish();">确定</button>
						</div>
					</div>

				</div>
			</div>
			<object id="HsEncoder_E1DC706E925B"
				classid="clsid:59F16F7C-EABF-4EE2-8B52-E1DC706E925B" width='0px'
				height='0px' style='' codebase=''> </object>
			<div class="hc_hide_div">
				<script type="text/javascript">
						Horn.Tip.clear() ;
					</script>
			</div>
		</div>

		<script type="text/javascript">
var form,//form
	f_img1,f_img2,
	clients,//客户代码信息
	branch_no,//营业部
	businsys_id,//业务系统编号
	mCode,//短信验证码轮询
	nCard;//换卡轮询
var TIMEOUT = 5 * 60 * 1000,//超时时间5分钟
	INTERVAL = 1000;//时间间隔

$(document).ready(function(){
	$("button").not("#msgBtn,.resetBtn").attr("disabled",true);
	form = Horn.getComp("bundlenewcardForm");
	branch_no = Horn.Field.getValue("branch_no");
	businsys_id = Horn.Field.getValue("businsys_id");
	$(".h_floatdiv-title a").text("×");
});

var newcard={
	success: function(data){
		var values = {
			cif_account: data.cif_account,
			full_name: data.full_name,
			id_kind: data.id_kind,
			id_no: data.id_no
		};
		form.setValues(values);
		$("button.h_btn-submit").attr("disabled",false);
		newcard.getClients(data.cif_account);
	},
	failure: function(error){
		alert(Horn.getError(error));
	},
	password:{
		check: function(){
			var password2 = Horn.getComp("password2").getValue();
			var busin_account = Horn.Field.getValue("busin_account");
			if(/\d{6,8}/.test(password2)){
				password2 = HsEncoder_E1DC706E925B.Encode(password2);
			}
			Horn.post("/iwm/newam/checkPassword.json",{branch_no:branch_no,fund_account: busin_account,fund_password: password2},function(){
				Horn.Validate.removeError($("input[name=password2]"));
			},function(error){
				Horn.Validate.addError("password2",Horn.getError(error));
			},false,false,false);
		}
	},
	submit: function(){
		var password2 = Horn.getComp("password2").getValue();
		if(/\d{6,8}/.test(password2)){
			Horn.getComp("password2").setValue(HsEncoder_E1DC706E925B.Encode(password2));
		}
		//if(!f_img1||!f_img2){
		//	alert("影像信息不完整!");
		//	return
		//}
		if(Horn.Validate.isFormValidate(form)){
			$(".submitBtn").attr("disabled",true);
			if(!newcard.bundleNewCard(0))return;
			newcard.repeat(0);
		}
	},
	repeat: function(i){
		var params = form.getValues()
		var step = [201,203,204,205];
		$("#step1").removeClass("default").addClass("success");
		var stepName="";
		var startTime = new Date().getTime();
		endTime = new Date().getTime();
		if(endTime - startTime >= TIMEOUT){
			alert("换卡超时[business_name="+stepName+"]");
			return;
		}
		var business_no = Horn.Field.getValue("business_no");
		Horn.post("/iwm/newam/getFlowStatus.json",{business_no: business_no,step_no: step[i]},function(result){
			if($.isArray(result)&&result.length>0){
				stepName = result[0].business_name;
				if(result[0].business_status=='2'){
					$("#step"+(i+1)).removeClass("default").addClass("success");
					if(step[i]==205){//资管换卡
						$("#step5").removeClass("default").addClass("success");
					}else if(i<=3){
						setTimeout("newcard.repeat("+(++i)+")",INTERVAL);
					}
				}else if(result[0].business_status=='3'){
					$("#step"+(i+1)).removeClass("default").addClass("error");
				}else if(i<=3){
					setTimeout("newcard.repeat("+i+")",INTERVAL);
				}
			}
		},function(error){
		},false, true, false);
	},
	bundleNewCard: function(i){
		var params = form.getValues()
		params.action_in=i;
		flag = true;
		Horn.post("/iwm/newam/bundleNewCard.json",params,function(result){
			flag = true;
		},function(error){
			alert(Horn.getError(error));
			flag = false;
		},false, false, false);
		return flag;
	},
	reset : function(b){
		form.setValues({gt_ztbank_no:"",old_bank_account:"",bank_account:"",re_bank_account:"",mobiletelephone:"",gt_msgChkNo:"",password2:""});
		if(b){
			form.setValues({account_content:"",cif_account:"",client_id:"",busin_account:""});
			$("button").not("#msgBtn,.resetBtn").attr("disabled",true);
		}else{
			$(".submitBtn").attr("disabled",true);
		}
		$("#idcard_img").attr("src","../../css/user/img/nophoto_03.gif");
		$("#scan_img").attr("src","../../css/user/img/nophoto_03.gif");
		$("div[id^='step']").removeClass("success").removeClass("error").addClass("default");
		f_img1=false;f_img2=false;
	},
	getClients: function(c){
		Horn.post("/iwm/newam/getClientId.json",{cif_account:c,branch_no:branch_no,businsys_id:businsys_id,en_client_status: "0,1,2"},function(result){
			if(jQuery.isArray(result)&&result.length>0){
         		clients = result;
            	form.setValues({"branch_no":result[0].branch_no});
            	Horn.getComp("client_id").keyAttr='client_id';
            	Horn.getComp("client_id").valueAttr='item_value';
            	Horn.getComp("client_id").addDatas(result,true);
            	Horn.getComp("client_id").selectFirst();
            	newcard.getBusinessAccount(result[0].client_id);
            }else{
               alert("该用户没有开通“客户代码”。");
               return;
            }
		},function(error){
			alert(Horn.getError(error));
		}, null, true);
	},
	clientChange: function(){
		var client_id = Horn.Field.getValue("client_id");
		for(var i in clients){
			if(clients[i].client_id == client_id){
				$("#branch_no").val(clients[i].branch_no);
				form.setValues({branch_no:clients[i].branch_no,branch_no_name:clients[i].branch_no_name});
				break;
			}
		}
		newcard.getBusinessAccount(client_id);
	},
	getBusinessAccount: function(client_id){
		Horn.post("/iwm/newam/getBusinAccounts.json",{client_id: client_id,businsys_id: businsys_id,en_businacct_status: '0,1',branch_no: branch_no},
	    function(result){
			if(jQuery.isArray(result)){
				Horn.getComp("busin_account").keyAttr='busin_account';
            	Horn.getComp("busin_account").valueAttr='busin_account';
				Horn.getComp("busin_account").addDatas(result,true);
				Horn.getComp("busin_account").selectFirst();
			}
		},function(error){
			alert(Horn.getError(error));
		}, false, true, false);
	},
	businessAccountChange: function(){
		newcard.reset(false);
		newcard.getBank();
	    var busin_account = Horn.getComp("busin_account").getValue();
		/**
		 * 君行天下密码校验
		 */
		var check_flag = Horn.Field.getValue("check_flag");
		var jxtx_fllow_flag_type = Horn.Field.getValue("jxtx_fllow_flag_type");
		var menu_id = Horn.Util.getParamValue("menu_id") ;
		var hsMune_Type=Horn.Field.getValue("hsMune_Type0");
		var action_Type_No1=Horn.Field.getValue("action_Type_No1");
		var jxtxbranch_no=Horn.Field.getValue("branch_no");
		var jxtxret=true;
		if(check_flag=="1"){
			if(hsMune_Type=="2"){
				var jxtxret =Iwm.Pwd.jxtxCheckPwd(menu_id,jxtx_fllow_flag_type,null,null,busin_account,jxtxbranch_no,"资金帐号");
			}else{
				if(hsMune_Type=="1"){
					if(action_Type_No1!="0"){
						var jxtxret =Iwm.Pwd.jxtxCheckPwd(menu_id,jxtx_fllow_flag_type,null,null,busin_account,jxtxbranch_no,"资金帐号");
					}
				}else{
					if(action_Type_No1!="0"){
						var jxtxret =Iwm.Pwd.jxtxCheckPwd(menu_id,jxtx_fllow_flag_type,null,null,busin_account,jxtxbranch_no,"资金帐号");
					}
				}
			}
		}
		if(jxtxret){
			
		}else{
			Horn.getComp('busin_account').setValue("");
			return;
		}
	},
	getBank:function(){
		var busin_account = Horn.Field.getValue("busin_account");
		Horn.post("/iwm/newam/getBank.json",{payorgan_id:9001,busin_account: busin_account},function(result){
			if(jQuery.isArray(result)&&result.length>0){
				Horn.Field.setValue("old_bank_account",result[0].bank_account);
				Horn.getComp("gt_ztbank_no").keyAttr='gt_ztbank_no';
            	Horn.getComp("gt_ztbank_no").valueAttr='name';
				Horn.getComp("gt_ztbank_no").addDatas(result,true);
				Horn.getComp("gt_ztbank_no").selectFirst();
			}
		},function(error){
			alert(Horn.getError(error));
		},null,true);
	},
	getMessageCode: function(){
		clearInterval(mCode);
		$("div[id^='step']").removeClass("success").removeClass("error").addClass("default");
		var bank_account = Horn.Field.getValue("bank_account");
		var mobiletelephone = Horn.Field.getValue("mobiletelephone");
		var gt_ztbank_no = Horn.Field.getValue("gt_ztbank_no");
		if(mobiletelephone==""){
			Horn.Validate.addError("mobiletelephone","请输入银行预留手机号!")
		}
		if(bank_account==""){
			Horn.Validate.addError("bank_account","请输入银行帐号!")
		}
		if(mobiletelephone==""||bank_account=="")return;
		Horn.hideMask();
		Horn.post("/iwm/newam/getMessageCode.json",{gt_ztbank_no:gt_ztbank_no,business_flag:59181,bank_account: bank_account,mobile_tel: mobiletelephone},function(result){
			Horn.Validate.removeError($("input[name=gt_msgChkNo]"));
			newcard.msgInterval();
			//短信流水号
			if($.isArray(result)&&result.length>0){
				Horn.Field.setValue("serial_no",result[0].serial_no);
				Horn.Field.setValue("position_str",result[0].position_str);
				var startTime = new Date().getTime();
				newcard.getMessageStatus(startTime);
			}
		},function(error){
			Horn.Validate.addError("gt_msgChkNo",Horn.getError(error));
		},null,true);
	},
	getMessageStatus: function(startTime){
		endTime = new Date().getTime();
		if(endTime - startTime >= TIMEOUT){
			Horn.Validate.addError("gt_msgChkNo","短信验证码发送超时!")
			clearInterval(mCode);
			return;
		}
		var position_str = Horn.Field.getValue("position_str");
		Horn.post("/iwm/newam/getFlowStatus.json",{position_str: position_str},function(data){
			if($.isArray(data)&&data[0].business_status=='2'){
				Horn.Field.setValue("gt_msgSndNo",data[0].gt_msgSndNo);
				Horn.Field.setValue("business_no",data[0].business_no);
				$(".submitBtn,.resetBtn").attr("disabled",false);
			}else if($.isArray(data)&&data[0].business_status=='3'){
				Horn.Validate.addError("gt_msgChkNo","短信验证码发送失败!")
			}else{
				setTimeout("newcard.getMessageStatus("+startTime+")",INTERVAL);
			}
		},function(error){
		},false,true,false);
	},
	msgInterval: function(){
		$("#msgBtn").attr("disabled",true);
		var init = 9;
		var mTime = setInterval(function(){
			$("#msgBtn").text(init);
			if(init--<0){
				$("#msgBtn").text("获取").attr("disabled",false);
				clearInterval(mTime);
			}
		},INTERVAL);
	},
	getGAIDInfo : function(){//取公安身份信息
	
		var account_content = Horn.Field.getValue("account_content") ;
		if(account_content==""){
			Horn.Validate.addError("account_content","当前输入不能为空!")
			return;
		}
		var id_kind = Horn.Field.getValue("id_kind") ;
		var id_no = Horn.Field.getValue("id_no") ;
		var client_name = Horn.Field.getValue("full_name") ;
		var idCardInfo_flag;
		//查询校验中登接口还是公安接口
		Horn.post("/iwm/cif/cifaccount/getIdCardInfoCheck.json",null,function(data){
			idCardInfo_flag=data.allow_flag;
		},function(data){
			alert(data.errorInfo);
		},null,false);
		if(idCardInfo_flag!="1"){
			var idINfo = Iwm.IdCard.openGAWin(id_kind,id_no,client_name);
		}else {
			var idINfoCsdc = Iwm.IdCard.openGAWinCDSC(id_kind,id_no,client_name,branch_no);
		}
		if(idINfo){
			var idINfo = Horn.Util.decode(idINfo) ;
			var names = ["client_name","full_name","birthday"] ;
			var props = ["client_name","client_name","birthday"] ;
			for(var i=0;i<names.length;i++){
				if(idINfo[props[i]]){
					Horn.getComp("client."+names[i]).setValue(idINfo[props[i]]) ;
				}
			}
			if(idINfo.url){
			   			   var client_id = Horn.getComp("cif_account").getValue();
		       var image_no = '82';
			   var url = context_path+"/archives/saveGAPic.json";
			   Horn.post(url,{"image_no":image_no,"client_id":client_id,"branch_no":branch_no,"id_no":id_no},function(data){
			  	   var scan_url = "archives/fileCachePics.htm?image_no="+image_no+"&client_id="+client_id +"&randStr=" +(new Date().getTime());
		            $("#idcard_img").attr("src",context_path + "/" + scan_url) ;
		            f_img1=true;
			   });
		
			}
		}
		if(idINfoCsdc){
			if(idINfoCsdc.url){
			    // 上传公安获取的头像到档案系统 
				var client_id = Horn.Field.getValue("cif_account");
			    var image_no = '82';
				var url = context_path+"/archives/saveGAPic.json";
				Horn.post(url,{"image_no":image_no,"client_id":client_id,"branch_no":branch_no,"id_no":id_no,"image_type":"02"},function(data){
					var scan_url = "archives/fileCachePics.htm?image_no="+image_no+"&client_id="+client_id +"&randStr=" +(new Date().getTime());
		            $("#idcard_img").attr("src",context_path + "/" + scan_url) ;
		            f_img1=true;
			   	});
				$("#idcard_img").attr("src",context_path + "/" + idINfoCsdc.url) ;
			}
		}
	},
	/**拍照*/
	scanImage : function(){
		var account_content = Horn.Field.getValue("account_content") ;
		if(account_content==""){
			Horn.Validate.addError("account_content","当前输入不能为空!")
			return;
		}
		var client_id = Horn.Field.getValue("cif_account");
		var image_no = '';
		image_no = '80';//客户头像
		var param  = {'image_no':image_no,'branch_no' : branch_no,'client_id' : client_id};	
		Horn.post("/archives/scanCacheConfig.json",param,function(data){
			Horn.getComp('scanFinish_window').show();
			location = 'ImagingScan:token='+data.acceptNo + ';sever=10.189.49.158:8088/imm                       ';
			$(".scan-finish-btn").attr("disabled",false);
		},function(data){
			if(data!=null  && typeof(data.exception)!="undefined") {
				alert("token生成失败："+data.exception.errorInfo);
			}else{
				alert("token生成失败：请求失败!");
			}
		});
	},
	scanFinish : function(){//客户头像
		var client_id = Horn.Field.getValue("cif_account") ;
		var image_no = '';
		image_no = '80';//客户头像
		var scan_url = "archives/fileCachePics.htm?image_no="+image_no+"&client_id="+client_id +"&randStr=" +(new Date().getTime());
	    $("#scan_img").attr("src",context_path + "/" + scan_url) ;
		f_img2=true;
		Horn.getComp('scanFinish_window').hide();
	}
}
function newcard_check_bank_account(v){
	if(!/^\d*$/.test(v))return "银行账号只能是数字!";
	var old_bank_account = Horn.Field.getValue("old_bank_account");
	if(old_bank_account==v) return "“新银行账号”和“旧银行账号”不能相同!";
	return true;
}
function newcard_check_re_bank_account(v){
	if(!/^\d*$/.test(v))return "银行账号只能是数字!";
	var bank_account = Horn.Field.getValue("bank_account");
	if(bank_account==v) return true;
	return "“确认银行账号”需要和“新银行账号”相同";
}
function newcard_check_mobiletelephone(v){
	if(!/^\d{11}$/.test(v))return "手机号只能是11位数字!";
	return true;
}
</script>

	</div>
</body>

</html>